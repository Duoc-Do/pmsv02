
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.2.0.min.js")" type="text/javascript"></script>   
    <script src="@Url.Content("~/Scripts/knockout-2.2.0.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/jquery.scrollTo-1.4.2-min.js")" type="text/javascript"></script>

<!-- Info boxes -->
<div class="row">
    <div class="col-md-3 col-sm-6 col-xs-12">
        </div>
    <div class="col-md-3 col-sm-6 col-xs-12">
        </div>
        <div class="col-md-3 col-sm-6 col-xs-12">
        </div>
<div class="col-md-3 col-sm-6 col-xs-12">
    <div class="box box-warning direct-chat direct-chat-warning">
        <div class="box-header with-border">
            <h3 class="box-title">Direct Chat</h3>
            <div class="box-tools pull-right">
                <span data-toggle="tooltip" title="3 New Messages" class='badge bg-yellow'>3</span>
                <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                  <button class="btn btn-box-tool" data-toggle="tooltip" title="Contacts" data-widget="chat-pane-toggle"><i class="fa fa-comments"></i></button>
                <button class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
            </div>
        </div>
        <!-- /.box-header -->
        <div class="box-body">
            <!-- Conversations are loaded here -->
            <div class="direct-chat-messages">
                <!-- Message. Default to the left -->
                <div class="direct-chat-msg">
                    <div class='direct-chat-info clearfix'>
                        <span class='direct-chat-name pull-left'>Alexander Pierce</span>
                        <span class='direct-chat-timestamp pull-right'>23 Jan 2:00 pm</span>
                    </div>
                    <!-- /.direct-chat-info -->
                    @*<img class="direct-chat-img" src="../dist/img/user1-128x128.jpg" alt="message user image" />*@
                    <!-- /.direct-chat-img -->
                    <div class="direct-chat-text">
                        Is this template really for free? That's unbelievable!
                    </div>
                    <!-- /.direct-chat-text -->
                </div>
                <!-- /.direct-chat-msg -->

                <!-- Message to the right -->
                <div class="direct-chat-msg right">
                    <div class='direct-chat-info clearfix'>
                        <span class='direct-chat-name pull-right'>Sarah Bullock</span>
                        <span class='direct-chat-timestamp pull-left'>23 Jan 2:05 pm</span>
                    </div>
                    <!-- /.direct-chat-info -->
                    @*<img class="direct-chat-img" src="../dist/img/user3-128x128.jpg" alt="message user image" />*@
                    <!-- /.direct-chat-img -->
                    <div class="direct-chat-text">
                        You better believe it!
                    </div>
                    <!-- /.direct-chat-text -->
                </div>
                <!-- /.direct-chat-msg -->

          

            </div>
            <!--/.direct-chat-messages-->

            <!-- Contacts are loaded here -->
            <div class="direct-chat-contacts">
                <ul class='contacts-list'>
                    <li>
                        <a href='#'>
                            @*<img class='contacts-list-img' src='../dist/img/user1-128x128.jpg' alt="Contact Avatar" />*@
                            <div class='contacts-list-info'>
                                <span class='contacts-list-name'>Count Dracula
                                <small class='contacts-list-date pull-right'>2/28/2015</small>
                                </span>
                                <span class='contacts-list-msg'>How have you been? I was...</span>
                            </div>
                            <!-- /.contacts-list-info -->
                        </a>
                    </li>

                    <!-- End Contact Item -->
                </ul>
                <!-- /.contatcts-list -->
            </div>
            <!-- /.direct-chat-pane -->
        </div>
        <!-- /.box-body -->
        <div class="box-footer">
            <div class="input-group">
                <input type="text" name="message" id="chatmessage" placeholder="Nhập nội dung ..." class="form-control" />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-warning btn-flat" id="send-btn">Gửi</button>
                </span>
            </div>
        </div>
        <!-- /.box-footer-->
    </div>
    <!--/.direct-chat -->
    <!-- /.info-box -->
</div>

</div>
<!-- /.row -->


<div id="header" class="gradient">
    <h2>senChat</h2>
</div>

<div id="myContainer" class="container-fluid">    
    <div class="row-fluid">
        <div id="thongbao"></div>
        <input type="text"  id="UserNameid"/>
        <button type="button" class="btn btn-default" id="joinserverid">Join</button>

        <input type="text"  id="groupnameid"/>
        <input type="text"  id="groupmessage"/>
        <button type="button" class="btn btn-default" id="sendgroupid">Send group</button>


        <!-- This  is the contact box -->        
        <div id="users-list" class="span2">
            <h4>Users</h4> 
            <ul data-bind="foreach: contacts">
                <li class="user-box"><span class="user-box-name" data-bind="text: UserName"></span></li>
            </ul>
        </div>
        <!-- This  is the chat box -->
        <div id="chat-list" class="span8" data-bind="foreach: messages">
            <ul>
                <li>
                    <div class="chat-listitem-UserName" data-bind="text: UserName">                    
                    </div>                
                    <div class="chat-listitem-message" data-bind="html: content">                    
                    </div>                
                    <div class="chat-listitem-timestamp" data-bind="text: timestamp.toLocaleTimeString()">
                    </div>
                </li>
            </ul>
        </div>
    </div>    
    <div id="compose" class="row-fluid">
        <div class="span2"></div>
        <div class="span8">    
             <div class="row-fluid">                        
                <div class="span10"><textarea id="compose-box" rows="2" cols="50" placeholder="Nhập nội dung ở đây"></textarea>     </div>
                <div class="span2"><button id="send-btn2" type="submit" class="btn btn-large btn-primary">Gửi</button>   </div>          
             </div>
        </div>        
    </div>

    @*<img class="img-circle" src="@(WebApp.Services.Media.PictureService.GetPictureUrl(WebApp.Services.GlobalUserContext.GetContext().SenUser.Avatar, 160))" alt="User Image"/>*@


</div>
@*<script src="~/Scripts/App/Hubs/senChat.js"></script>*@
<!-- 
This script reference is important because navigating to /signalr/hubs will automatically generate the script. 
This should be done via an HttpModule automatically generated by SignalR on the server side 
https://github.com/SignalR/SignalR/wiki/SignalR-JS-Client-Hubs
If you navigate to signalr/hubs in your browser, you'll see a script that is dynamically generated based on the hubs declared
on the server. Each hub on the server will become a property on the client side $.connection, e.g. $.connection.myHub.
 -->
<script type="text/javascript" src="@Url.Content("/signalr/hubs")"></script>  
<script type="text/javascript" src="@Url.Content("~/Scripts/App/Hubs/senChat.js")"></script>
<script type="text/javascript" charset="utf-8">

    
    // IE doesn't parse IS8601 formatted dates, so I had to find this function to parse it
    // (URL http://dansnetwork.com/javascript-iso8601rfc3339-date-parser/ )
    Date.prototype.setISO8601 = function(dString){

        var regexp = /(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;

        if (dString.toString().match(new RegExp(regexp))) {
            var d = dString.match(new RegExp(regexp));
            var offset = 0;

            this.setUTCDate(1);
            this.setUTCFullYear(parseInt(d[1],10));
            this.setUTCMonth(parseInt(d[3],10) - 1);
            this.setUTCDate(parseInt(d[5],10));
            this.setUTCHours(parseInt(d[7],10));
            this.setUTCMinutes(parseInt(d[9],10));
            this.setUTCSeconds(parseInt(d[11],10));
            if (d[12])
                this.setUTCMilliseconds(parseFloat(d[12]) * 1000);
            else
                this.setUTCMilliseconds(0);
            if (d[13] != 'Z') {
                offset = (d[15] * 60) + parseInt(d[17],10);
                offset *= ((d[14] == '-') ? -1 : 1);
                this.setTime(this.getTime() - offset * 60 * 1000);
            }
        }
        else {
            this.setTime(Date.parse(dString));
        }
        return this;
    };

    var chatapp = {};

    $(document).ready(function () {

        $('.direct-chat .direct-chat-contacts .contacts-list,.direct-chat .direct-chat-messages').slimScroll({
            color: "rgba(0,0,0,0.2)",
            size: "3px"
        });

        function removecontact(user) {
            $("#" + user.Id).remove();
        };
        function addcontact(user) {
            var date = new Date();
            date.setISO8601(user.LastActive);

            $("#" + user.Id).remove();
            //alert(user.Id);
            var li = $('<li></li>');
            $(li).attr("id", user.Id);

            var lia = '<a href="javascript:;" onclick="chatapp.activecontact(this)"><img class="contacts-list-img" src="' + user.Avatar + '" alt="Contact Avatar" /><div class="contacts-list-info"><span class="contacts-list-name">' + user.UserName + '</span><small class="contacts-list-date pull-right">' + date.toLocaleTimeString() + '</small></div></a>';

            @*<img class='contacts-list-img' src='../dist/img/user1-128x128.jpg' alt="Contact Avatar" />*@

            //Count Dracula
            // <small class='contacts-list-date pull-right'>2/28/2015</small>
            // <span class='contacts-list-msg'>How have you been? I was...</span>

            $(li).append(lia);
            $(".direct-chat .direct-chat-contacts .contacts-list").append(li);
        };



        var chat = new senChat.chatViewModel();
        var users = new senChat.connectedUsersViewModel();
        //var currentUser = new senChat.user(@Html.Raw(Json.Encode(Model))); // The UserName chose by the user is stored in the model
        var currentUser = new senChat.user(
            "@WebApp.Services.GlobalUserContext.GetContext().SenUser.FullName",
            "@WebApp.Services.GlobalUserContext.GetContext().SenUser.SenUserId",
            "@(WebApp.Services.Media.PictureService.GetPictureUrl(WebApp.Services.GlobalUserContext.GetContext().SenUser.Avatar, 120,120))"
            ); // The UserName chose by the user is stored in the model

        // Proxy creation
        var appHub = $.connection.appHub; // appHub is the name of the Hub as declared in server side code
        appHub.state.UserName = currentUser.UserName; // This is the round-trip state
        appHub.state.userId = currentUser.Id; // This is the round-trip state

        // Client-side event handlers, as declared inside the  Hub
        appHub.client.onMessageReceived = function (message) {
            //alert(message.Content);
            var date = new Date();
            date.setISO8601(message.Timestamp);
            var chatmsg = new senChat.chatMessage(message.UserName, message.Content, date,message.Avatar);
            chat.messages.push(chatmsg);//new Date(message.Timestamp)));
            chatapp.addmessage(chatmsg);
            //$("#chat-list").scrollTo('max');

            //alert(message.UserName);
        }
        
        appHub.client.leaves = function (userId, UserName, timestamp) {
            var disconnectedUser = new senChat.user(UserName, userId);
            users.customRemove(disconnectedUser);
            removecontact(disconnectedUser);

        }

        appHub.client.joins = function (userId, UserName, timestamp,avatar) {
            var connectedUser = new senChat.user(UserName, userId, avatar, timestamp);

            //users.contacts.push(connectedUser);
            var li = '<li class="user-box"><span class="user-box-name">' + UserName + '</span></li>';
            $("#users-list ul").append(li);
            addcontact(connectedUser);
        }

        appHub.client.thongbao = function (message)
        {
            $("#thongbao").text(message);
        }

        function joinserver() {
            //var appHub = $.connection.appHub;
            appHub.state.UserName = appHub.state.userId; //$("#UserNameid").val();
            currentUser.UserName = appHub.state.UserName;
            //currentUser.Avatar = avatar;
            //alert(appHub.state.UserName);
            appHub.server.joined();
        }

        function sendMessageContent() {
            var content = $("#chatmessage").val();
            if (content != "" && content != null) {
                var msg = new senChat.chatMessage(currentUser.UserName, content,null,currentUser.Avatar);
                appHub.server.send(msg).done(function () {
                    $("#chatmessage").val("");
                }).fail(function (e) {
                    alert("Could not connect to server");
                });
            }
        }

        function sendgroupMessageContent() {
            var content = $("#groupmessage").val();
            var groupname = $("#groupnameid").val();
            if (content != "" && content != null) {
                var msg = new senChat.chatMessage(currentUser.UserName, content);
                appHub.server.sendToGroup(groupname,msg).done(function () {
                    $("#groupmessage").val("");
                }).fail(function (e) {
                    alert("Could not connect to server");
                });
            }
        }


        $("#joinserverid").click(function ()
        {
            joinserver();
        });

        $("#send-btn").click(function () {
            sendMessageContent();
        });

        $("#sendgroupid").click(function () {
            sendgroupMessageContent();
        });


        // Handles Enter keystroke press event
        $('#compose-box,#chatmessage').keypress(function (e) {
            if (e.which == 13) {
                sendMessageContent();
            }
        });

        ko.applyBindings(users, $("#users-list")[0]);
        ko.applyBindings(chat, $("#chat-list")[0]);

        // Step 1: Start the connection
        // Step 2: Get all currenlty connected users
        // Step 3: Join to the chat and nmotify all the clients (me included) that there is a new user connected
        $.connection.hub.start()
                    .done(function () {
                        appHub.server.getConnectedUsers()
                                    .done(function (connectedUsers) {
                                        ko.utils.arrayForEach(connectedUsers, function (item) {
                                            //users.contacts.push(new senChat.user(item.UserName, item.Id));
                                            var li = '<li class="user-box"><span class="user-box-name">' + item.UserName + '</span></li>';
                                            $("#users-list ul").append(li);
                                            //alert("chuoi");
                                            addcontact(item);
                                        });
                                    }).done(function () {
                                        appHub.server.joined();
                                    });
                    });

        chatapp.currentUser = currentUser;

        chatapp.activecontact = function (userid) {
            var _userid = $(userid).closest("li").attr("id");
            //alert(_userid);
        };

        chatapp.addmessage = function (info) {

            var div = $('<div class="direct-chat-msg right"></div>');

            var divinfo = $("<div class='direct-chat-info clearfix'></div>");
            var divinfospan1 = $("<span class='direct-chat-name pull-right'>" + info.UserName + "</span>");



            var divinfospan2 = $("<span class='direct-chat-timestamp pull-left'>" + info.timestamp.toLocaleTimeString() + "</span>");

            if (chatapp.currentUser.UserName == info.UserName) {
                $(div).removeClass("right");
                $(divinfospan1).removeClass("pull-right").addClass("pull-left");
                $(divinfospan2).removeClass("pull-left").addClass("pull-right");
            }


            $(divinfo).append(divinfospan1);
            $(divinfo).append(divinfospan2);

            var divimg = $('<img class="direct-chat-img" src="' + info.Avatar + '" alt="hình" />');
            var divchat = $('<div class="direct-chat-text">' + info.content + '</div>');

            $(div).append(divinfo);
            $(div).append(divimg);
            $(div).append(divchat);

            $('.direct-chat-messages').append(div).scrollTo('max');

        }
    }); 

</script>
