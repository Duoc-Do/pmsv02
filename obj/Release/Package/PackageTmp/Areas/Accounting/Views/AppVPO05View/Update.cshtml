@model WebApp.Areas.Accounting.Models.AppVPO05View
@using WebApp.Areas.Accounting.Services
@{
    Dictionary<string, string> ajaxoption = (Dictionary<string, string>)ViewBag.ajaxoption;
}

@Html.Partial("_AddNew")
<section id="@(ajaxoption["ajaxupdateid"])">
    <div class="box box-primary">
        @Html.Partial("_HeaderEdit")

        @using (@Ajax.BeginForm(new AjaxOptions { LoadingElementId = ajaxoption["ajaxloadingid"], InsertionMode = InsertionMode.Replace, UpdateTargetId = ajaxoption["ajaxupdateid"] }))
        {  
            <div class="box-body">
                @Html.AntiForgeryToken()
                @Html.bsValidationSummary(false)

                <h3>Thông tin chung</h3>
                @Html.svHiddenFor(model => model.DocumentID)
                @Html.svHiddenFor(model => model.ParentID)
                @Html.svHiddenFor(model => model.CurrencyID)
                @Html.svHiddenFor(model => model.CustomerID)
                @Html.svHiddenFor(model => model.PostType)
                @Html.svHiddenFor(model => model.VoucherID)
                @Html.svHiddenFor(model => model.VoucherCode)
                @Html.svHiddenFor(model => model.VoucherName)
                @Html.svHiddenFor(model => model.AccountCreditID)
                                @Html.svHiddenFor(model => model.CreatedBy)
                @Html.svHiddenFor(model => model.CreatedDateTime)
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="row-fluid">
                            <div class="row">
                                <div class="col-md-6">
                                    @Html.bsEditorFor(model => model.VoucherDate)
                                    @Html.bsEditorFor(model => model.VoucherNumber)
                                </div>
                                <div class="col-md-6">
                                    @Html.bsEditorFor(model => model.IsoCode)
                                    @Html.bsEditorFor(model => model.ExchangeRate)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-body">

                        <div class="row">
                            <div class="col-md-6">

                                @Html.bsEditorFor(model => model.CustomerCode)
                                @Html.bsTextAreaFor(model => model.CustomerName)
                            </div>
                            <div class="col-md-6">
                                @Html.bsTextAreaFor(model => model.Address)

                                @Html.bsEditorFor(model => model.Contact)
                            </div>
                        </div>

                        @Html.bsTextAreaFor(model => model.Description)
                        <div class="row">
                            <div class="col-md-6">
                                @Html.bsEditorFor(model => model.DisplayNumberCredit)
                            </div>
                            <div class="col-md-6">
                                @*@Html.bsEditorFor(model => model.IsFixPrice)*@
                            </div>
                        </div>

                    </div>
                </div>

                @*Lưới chi tiết hạch toán*@
                <div class="row-fluid">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Hạch toán</h3>
                        </div>
                        <div id="divAppVPO05LineView" class="sv-grid-container">
                            @Html.svGridVoucher(Model.AppVPO05LineViews, "DocumentLineID", "0", new WebApp.Areas.Accounting.Models.AppVPO05LineView())
                        </div>
                    </div>

                </div>

                @*Lưới chi tiết thuế*@
                <div class="row-fluid">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Thuế</h3>
                        </div>
                        <div id="divAppVPO05VATView" class="sv-grid-container">
                            @Html.svGridVoucher(Model.AppVPO05VATViews, "DocumentVATID", "0", new WebApp.Areas.Accounting.Models.AppVPO05VATView())
                        </div>
                    </div>
                </div>

                @*Tổng cộng*@
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                @Html.bsEditorFor(model => model.SumQuantity0)
                            </div>

                            <div class="col-md-4" id="tb_FC">
                                @Html.bsEditorFor(model => model.SumAmountFC)                                @Html.bsEditorFor(model => model.SumDutyFC)                                @Html.bsEditorFor(model => model.SumAmountCostFC)                                @Html.bsEditorFor(model => model.SumAmountVATFC)
                                @Html.bsEditorFor(model => model.SumTotalFC)
                            </div>

                            <div class="col-md-4">
                                @Html.bsEditorFor(model => model.SumAmount)                                @Html.bsEditorFor(model => model.SumDuty)
                                @Html.bsEditorFor(model => model.SumAmountCost)
                                @Html.bsEditorFor(model => model.SumAmountVAT)
                                @Html.bsEditorFor(model => model.SumTotal)
                            </div>
                        </div>
                    </div>
                </div>
                @Html.Partial("_ToolbarVoucherUpdate", ajaxoption)
            </div>

        }
        @Html.Partial("_FooterEdit")
    </div>
</section>

@Scripts.Render("~/bundles/accapp")

<script type="text/javascript">

    var globlevar_isocode = "@(Voucher.GetIsoCode())";

    $(document).ready(function () {
        hideshowgrid();
        form_refresh();
    });

    function hideshowgrid() {
        var sectionid = "#@(ajaxoption["ajaxupdateid"]) ";
        var IsoCode = $(sectionid + '#IsoCode').val();
        var isFC = (IsoCode.toUpperCase() != globlevar_isocode.toUpperCase());

        var fieldFC = "[fieldname=AmountFC],[fieldname=UnitPriceFC],[fieldname=DutyFC],[fieldname=AmountCostFC]";
        var fieldvatFC = "[fieldname=AmountVATFC],[fieldname=AmountFC]";
        if (isFC == true) {

            $("#divAppVPO05LineView table:first tr").children(fieldFC).each(function () {
                $(this).show();
            });

            $("#divAppVPO05LineView table:first tbody tr td").children(fieldFC).each(function () {
                $(this).parent().show();
            });

            //thue
            $("#divAppVPO05VATView table:first tr").children(fieldvatFC).each(function () {
                $(this).show();
            });

            $("#divAppVPO05VATView table:first tbody tr td").children(fieldvatFC).each(function () {
                $(this).parent().show();
            });
            //master

            $(sectionid + "#tb_FC").show();
        }
        else {
            $("#divAppVPO05LineView table:first tr").children(fieldFC).each(function () {
                $(this).hide();
            });

            $("#divAppVPO05LineView table:first tbody tr td").children(fieldFC).each(function () {
                $(this).parent().hide();
            });

            //thue
            $("#divAppVPO05VATView table:first tr").children(fieldvatFC).each(function () {
                $(this).hide();
            });

            $("#divAppVPO05VATView table:first tbody tr td").children(fieldvatFC).each(function () {
                $(this).parent().hide();
            });
            //master
            $(sectionid + "#tb_FC").hide();
        }
    }

    function form_refresh() {

        var SumQuantity0 = 0;

        var SumAmount = 0;
        var SumDuty = 0;
        var SumAmountCost = 0;
        var SumAmountVAT = 0;
        var SumTotal = 0;

        var SumAmountFC = 0;
        var SumDutyFC = 0;
        var SumAmountCostFC = 0;
        var SumAmountVATFC = 0;
        var SumTotalFC = 0;

        var sectionid = "#@(ajaxoption["ajaxupdateid"]) ";

        $("#divAppVPO05LineView table:first >tbody>tr:visible").each(function () {

            if ($(this).attr("rownumber") != "-1") {
                SumQuantity0 += parseFloat($(this).find('input[fieldname = "Quantity0"]:first').autoNumericGet());

                SumAmount += parseFloat($(this).find('input[fieldname = "Amount"]:first').autoNumericGet());
                SumDuty += parseFloat($(this).find('input[fieldname = "Duty"]:first').autoNumericGet());
                SumAmountCost += parseFloat($(this).find('input[fieldname = "AmountCost"]:first').autoNumericGet());

                SumAmountFC += parseFloat($(this).find('input[fieldname = "AmountFC"]:first').autoNumericGet());
                SumDutyFC += parseFloat($(this).find('input[fieldname = "DutyFC"]:first').autoNumericGet());
                SumAmountCostFC += parseFloat($(this).find('input[fieldname = "AmountCostFC"]:first').autoNumericGet());
            }

        });

        $("#divAppVPO05VATView table:first >tbody>tr:visible").each(function () {

            if ($(this).attr("rownumber") != "-1") {

                var AmountVAT = $(this).find('input[fieldname = "AmountVAT"]:first');
                var AmountVATFC = $(this).find('input[fieldname = "AmountVATFC"]:first');

                SumAmountVAT += parseFloat($(AmountVAT).autoNumericGet());
                SumAmountVATFC += parseFloat($(AmountVATFC).autoNumericGet());
            }

        });

        $(sectionid + "#SumQuantity0").autoNumericSet(SumQuantity0);

        $(sectionid + "#SumAmount").autoNumericSet(SumAmount);
        $(sectionid + "#SumDuty").autoNumericSet(SumDuty);
        $(sectionid + "#SumAmountCost").autoNumericSet(SumAmountCost);
        $(sectionid + "#SumAmountVAT").autoNumericSet(SumAmountVAT);

        SumTotal = SumAmount + SumAmountVAT + SumAmountCost + SumDuty;
        $(sectionid + "#SumTotal").autoNumericSet(SumTotal);


        $(sectionid + "#SumAmountFC").autoNumericSet(SumAmountFC);
        $(sectionid + "#SumDutyFC").autoNumericSet(SumDutyFC);
        $(sectionid + "#SumAmountCostFC").autoNumericSet(SumAmountCostFC);
        $(sectionid + "#SumAmountVATFC").autoNumericSet(SumAmountVATFC);

        SumTotalFC = SumAmountFC + SumAmountVATFC + SumAmountCostFC + SumDutyFC;
        $(sectionid + "#SumTotalFC").autoNumericSet(SumTotalFC);

    }

    function validnumberline(row) {
        var sectionid = "#@(ajaxoption["ajaxupdateid"]) ";
        var IsoCode = $(sectionid + '#IsoCode').val();
        var isFC = (IsoCode.toUpperCase() != globlevar_isocode.toUpperCase());
        if (isFC) {

            //var Credit = $(row).find('input[fieldname = "Credit"]:first');
            //var CreditValue = 0;
            //var ExchangeRateLineValue = $(row).find('input[fieldname = "ExchangeRateLine"]:first').autoNumericGet();

            //var Amount = $(row).find('input[fieldname = "Amount"]:first');
            //var AmountValue = 0;
            //var AmountFCValue = $(row).find('input[fieldname = "AmountFC"]:first').autoNumericGet();
            //var ExchangeRateValue = $(sectionid + '#ExchangeRate').autoNumericGet();

            //AmountValue = parseFloat(ExchangeRateValue) * parseFloat(AmountFCValue);
            //CreditValue = parseFloat(ExchangeRateLineValue) * parseFloat(AmountFCValue);

            //$(Amount).autoNumericSet(AmountValue);
            //$(Credit).autoNumericSet(CreditValue);

        }
        form_refresh();

    }

    function validnumbervat(row) {
        var sectionid = "#@(ajaxoption["ajaxupdateid"]) ";
        var IsoCode = $(sectionid + '#IsoCode').val();
        var isFC = (IsoCode.toUpperCase() != globlevar_isocode.toUpperCase());

        if (isFC) {
            var Amount = $(row).find('input[fieldname = "Amount"]:first');
            var AmountValue = 0;
            var AmountFCValue = $(row).find('input[fieldname = "AmountFC"]:first').autoNumericGet();
            var ExchangeRateValue = $(sectionid + '#ExchangeRate').autoNumericGet();
            AmountValue = parseFloat(ExchangeRateValue) * parseFloat(AmountFCValue);
            $(Amount).autoNumericSet(AmountValue);

            var AmountVAT = $(row).find('input[fieldname = "AmountVAT"]:first');
            var AmountVATValue = 0;
            var AmountVATFCValue = $(row).find('input[fieldname = "AmountVATFC"]:first').autoNumericGet();
            var ExchangeRateValue = $(sectionid + '#ExchangeRate').autoNumericGet();
            AmountVATValue = parseFloat(ExchangeRateValue) * parseFloat(AmountVATFCValue);
            $(AmountVAT).autoNumericSet(AmountVATValue);
        }
        form_refresh();
    }

    function fieldchange(a) {
        var $thisobject = $(a);
        var val = $(a).val();
        var fieldname = $(a).attr("fieldname");
        var url = '@Url.Action("FieldChange")';
        var sectionid = "#@(ajaxoption["ajaxupdateid"]) ";
        switch (fieldname) {
            case "IsoCode":
                //lấy dòng du lieu ve gan cho may cai khac
                $(sectionid + '#CurrencyID').val("");
                $(sectionid + '#ExchangeRate').val(1);
                if (val != "") {
                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 0, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(sectionid + '#CurrencyID').val(data.rows.CurrencyID);
                                $(sectionid + '#ExchangeRate').autoNumericSet(data.rows.ExchangeRate);

                                $("#divAppVPO05LineView table:first >tbody>tr:visible").each(function () {

                                    if ($(this).attr("rownumber") != "-1") {

                                        validnumberline(this);
                                    }

                                });
                                $("#divAppVPO05VATView table:first >tbody>tr:visible").each(function () {

                                    if ($(this).attr("rownumber") != "-1") {

                                        validnumbervat(this);
                                    }

                                });
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                            hideshowgrid();

                        }
                    });
                }
                break;
            case "ExchangeRate":

                $("#divAppVPO05LineView table:first >tbody>tr:visible").each(function () {

                    if ($(this).attr("rownumber") != "-1") {

                        validnumberline(this);
                    }

                });
                $("#divAppVPO05VATView table:first >tbody>tr:visible").each(function () {

                    if ($(this).attr("rownumber") != "-1") {

                        validnumbervat(this);
                    }

                });

                break;
            case "CustomerCode":
                //lấy dòng du lieu ve gan cho may cai khac

                $(sectionid + '#CustomerID').val("");
                $(sectionid + '#CustomerName').val("");
                if (val != "") {

                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 0, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(sectionid + '#CustomerID').val(data.rows.CustomerID);
                                $(sectionid + '#CustomerName').val(data.rows.Name);

                                $(sectionid + '#Contact').val(data.rows.Contact);
                                $(sectionid + '#Address').val(data.rows.Address);

                                $("#divAppVPO05VATView table:first >tbody>tr:visible").each(function () {

                                    if ($(this).attr("rownumber") != "-1") {
                                        $(this).find('input[fieldname = "CustomerName"]').first().val('');
                                        $(this).find('input[fieldname = "CustomerAddress"]').first().val('');
                                        $(this).find('input[fieldname = "TaxCode"]').first().val('');

                                        fieldchange($(this).find('input[fieldname = "VATDate"]').first());
                                    }

                                });
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "DisplayNumberCredit":
                $(sectionid + "#AccountCreditID").val("");
                if (val != "") {
                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 0, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(sectionid + "#AccountCreditID").val(data.rows.AccountID);
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "VATDate":
                if (val != "") {
                    var $tr = $thisobject.closest("tr");
                    //$.ajax({
                    //    type: "GET", url: url, dataType: "json",
                    //    data: { type: 2, fieldname: fieldname, keyword: "", voucherdate: val },
                    //    success: function (data) {
                    //        if (data.rows != null) {
                    //            var VATNumber = $tr.find('input[fieldname = "VATNumber"]').first();
                    //            if ($(VATNumber).val() == "") {
                    //                $(VATNumber).val(data.rows.VATNumber);
                    //            }
                    //            var VATSerial = $tr.find('input[fieldname = "VATSerial"]').first();
                    //            if ($(VATSerial).val() == "") {
                    //                $(VATSerial).val(data.rows.VATSerial);
                    //            }

                    //        }
                    //    }
                    //});

                    //nếu tên khách trống thì lấy tên khách trong master
                    var CustomerName = $tr.find('input[fieldname = "CustomerName"]').first();
                    if ($(CustomerName).val() == "") {
                        $(CustomerName).val($(sectionid + '#CustomerName').val());
                    }

                    //nếu địa chỉ trống thì lấy trong master
                    var CustomerAddress = $tr.find('input[fieldname = "CustomerAddress"]').first();
                    if ($(CustomerAddress).val() == "") {
                        $(CustomerAddress).val($(sectionid + '#Address').val());
                    }

                    //nếu mã số thuế trống thì lấy trong master
                    var TaxCode = $tr.find('input[fieldname = "TaxCode"]').first();
                    if ($(TaxCode).val() == "") {
                        $.ajax({
                            type: "GET", url: url, dataType: "json",
                            data: { type: 2, fieldname: "CustomerCode", keyword: $(sectionid + '#CustomerCode').selectizegetvalue() },
                            success: function (data) {
                                if (data.rows != null) {
                                    $(TaxCode).val(data.rows.TaxCode);

                                }
                            }
                        });
                    }

                    //nếu tiền hàng trống thì lấy trong master
                    var Amount = $tr.find('input[fieldname = "Amount"]').first();
                    if ($(Amount).val() == "") {
                        $(Amount).val($(sectionid + '#SumAmount').val());
                    }
                    //ngoại tệ
                    var AmountFC = $tr.find('input[fieldname = "AmountFC"]').first();
                    if ($(AmountFC).val() == "") {
                        $(AmountFC).val($(sectionid + '#SumAmountFC').val());
                    }

                }
                break;
            case "SalesTaxCode":
                // phải chú ý trường hợp tên trường giống nhau ở 2 bảng chi tiết và thuế . nếu muốn xử lý khác thì phải kèm theo id thì mới chính xác
                var $tr = $thisobject.closest("tr");

                var SalesTaxID = $tr.find('input[fieldname = "SalesTaxID"]').first();
                $(SalesTaxID).val("");

                var Percentage = $tr.find('input[fieldname = "Percentage"]').first();
                $(Percentage).val("");

                var AmountVAT = $tr.find('input[fieldname = "AmountVAT"]').first();
                $(AmountVAT).val("");

                var AmountVATFC = $tr.find('input[fieldname = "AmountVATFC"]').first();
                $(AmountVATFC).val("");

                var Amount = $tr.find('input[fieldname = "Amount"]').first();
                var AmountFC = $tr.find('input[fieldname = "AmountFC"]').first();
                var DisplayNumberLineCredit = $tr.find('select[fieldname = "DisplayNumberLineCredit"]').first();

                form_refresh();

                if (val != "") {

                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 2, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(SalesTaxID).val(data.rows.SalesTaxID);
                                $(Percentage).val(data.rows.Percentage);
                                var AmountVATValue = (parseFloat($(Amount).autoNumericGet()) * parseFloat(data.rows.Percentage)) / 100;
                                $(AmountVAT).autoNumericSet(AmountVATValue);

                                //ngoại tệ
                                var AmountVATFCValue = (parseFloat($(AmountFC).autoNumericGet()) * parseFloat(data.rows.Percentage)) / 100;
                                $(AmountVATFC).autoNumericSet(AmountVATFCValue);

                                $(SalesTaxID).val(data.rows.SalesTaxID);
                                form_refresh();

                                if ($(DisplayNumberLineCredit).selectizegetvalue() == "") {
                                    $(DisplayNumberLineCredit).selectizesetvalue(data.rows.DisplayNumber);
                                    fieldchange(DisplayNumberLineCredit);
                                }
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;


            case "DisplayNumberLineDebit":
                var $tr = $thisobject.closest("tr");
                var AccountDebitLineID = $tr.find('input[fieldname = "AccountDebitLineID"]').first();
                $(AccountDebitLineID).val("");

                if (val != "") {

                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 1, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(AccountDebitLineID).val(data.rows.AccountID);
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;

            case "PurchaseTaxCode":
                // phải chú ý trường hợp tên trường giống nhau ở 2 bảng chi tiết và thuế . nếu muốn xử lý khác thì phải kèm theo id thì mới chính xác
                var $tr = $thisobject.closest("tr");

                var PurchaseTaxID = $tr.find('input[fieldname = "PurchaseTaxID"]').first();
                $(PurchaseTaxID).val("");

                var Percentage = $tr.find('input[fieldname = "Percentage"]').first();
                $(Percentage).val("");

                var AmountVAT = $tr.find('input[fieldname = "AmountVAT"]').first();
                $(AmountVAT).val("");

                var AmountVATFC = $tr.find('input[fieldname = "AmountVATFC"]').first();
                $(AmountVATFC).val("");

                var Amount = $tr.find('input[fieldname = "Amount"]').first();
                var AmountFC = $tr.find('input[fieldname = "AmountFC"]').first();
                var DisplayNumberLineDebit = $tr.find('select[fieldname = "DisplayNumberLineDebit"]').first();

                form_refresh();

                if (val != "") {

                    $.ajax({
                        type: "POST", url: url, dataType: "json",
                        data: { type: 2, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(PurchaseTaxID).val(data.rows.PurchaseTaxID);
                                $(Percentage).val(data.rows.Percentage);
                                var AmountVATValue = (parseFloat($(Amount).autoNumericGet()) * parseFloat(data.rows.Percentage)) / 100;
                                $(AmountVAT).autoNumericSet(AmountVATValue);

                                //ngoại tệ
                                var AmountVATFCValue = (parseFloat($(AmountFC).autoNumericGet()) * parseFloat(data.rows.Percentage)) / 100;
                                $(AmountVATFC).autoNumericSet(AmountVATFCValue);


                                $(PurchaseTaxID).val(data.rows.PurchaseTaxID);
                                form_refresh();

                                if ($(DisplayNumberLineDebit).selectizegetvalue() == "") {
                                    $(DisplayNumberLineDebit).selectizesetvalue(data.rows.DisplayNumber);
                                    fieldchange(DisplayNumberLineDebit);
                                }
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "DisplayNumberLineDebit":
                var $tr = $thisobject.closest("tr");
                var AccountDebitLineID = $tr.find('input[fieldname = "AccountDebitLineID"]').first();
                $(AccountDebitLineID).val("");

                if (val != "") {
                    var tablename = $tr.closest("table").attr("tablename");

                    if (tablename == "AppVCA02VATView") {
                        $.ajax({
                            type: "POST", url: url, dataType: "json",
                            data: { type: 2, fieldname: fieldname, keyword: val },
                            success: function (data) {
                                if (data.rows != null) {
                                    //alert(data.rows.AccountDebitLineID);
                                    $(AccountDebitLineID).val(data.rows.AccountID);
                                }
                                else {
                                    $thisobject[0].selectize.setValue('');
                                    $thisobject[0].selectize.clearOptions();
                                }
                            }
                        });
                    }
                    else {
                        var customercode = $(sectionid + '#CustomerCode').val();
                        var voucherdate = $(sectionid + '#VoucherDate').val();
                        $.ajax({
                            type: "POST", url: url, dataType: "json",
                            data: { type: 1, fieldname: fieldname, keyword: val, voucherdate: voucherdate, customercode: customercode },
                            success: function (data) {
                                if (data.rows != null) {
                                    $(AccountDebitLineID).val(data.rows.AccountID);
                                    var ExchangeRateLine = $tr.find('input[fieldname = "ExchangeRateLine"]').first();
                                    if (data.rows.ExchangeRateLine != 0) {
                                        $(ExchangeRateLine).val(data.rows.ExchangeRateLine);
                                    }
                                    else {
                                        $(ExchangeRateLine).autoNumericSet(parseFloat($(sectionid + '#ExchangeRate').autoNumericGet()));
                                    }
                                    //ngoại tệ
                                    var AmountFC = $tr.find('input[fieldname = "AmountFC"]').first();
                                    var Debit = $tr.find('input[fieldname = "Debit"]').first();
                                    if ($(AmountFC).val() != 0) {
                                        var DebitValue = (parseFloat($(AmountFC).autoNumericGet()) * parseFloat($(ExchangeRateLine).autoNumericGet()));
                                        $(Debit).autoNumericSet(DebitValue);
                                    }
                                }
                                else {
                                    $thisobject[0].selectize.setValue('');
                                    $thisobject[0].selectize.clearOptions();
                                }
                            }
                        });
                    }
                }
                break;

            case "DisplayNumberLine1Credit":
                // phải chú ý trường hợp tên trường giống nhau ở 2 bảng chi tiết và thuế . nếu muốn xử lý khác thì phải kèm theo id thì mới chính xác
                var $tr = $thisobject.closest("tr");
                var AccountCreditLine1ID = $tr.find('input[fieldname = "AccountCreditLine1ID"]').first();
                $(AccountCreditLine1ID).val("");
                if (val != "") {
                    var tablename = $tr.closest("table").attr("tablename");
                    if (tablename == "AppVPO05VATView") { }
                    else {
                        var customercode = $(sectionid + '#CustomerCode').val();
                        var voucherdate = $(sectionid + '#VoucherDate').val();
                        $.ajax({
                            type: "GET", url: url, dataType: "json",
                            data: { type: 1, fieldname: fieldname, keyword: val, voucherdate: voucherdate, customercode: customercode },
                            success: function (data) {
                                if (data.rows != null) {
                                    $(AccountCreditLine1ID).val(data.rows.AccountID);
                                }
                                else {
                                    $thisobject[0].selectize.setValue('');
                                    $thisobject[0].selectize.clearOptions();
                                }
                            }
                        });
                    }
                }
                break;
            case "WarehouseLineCode":
                var $tr = $thisobject.closest("tr");
                var WarehouseLineID = $tr.find('input[fieldname = "WarehouseLineID"]').first();
                var WarehouseLineName = $tr.find('input[fieldname = "WarehouseLineName"]').first();

                $(WarehouseLineID).val("");
                $(WarehouseLineName).val("");

                if (val != "") {
                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 1, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(WarehouseLineID).val(data.rows.WarehouseID);
                                $(WarehouseLineName).val(data.rows.Name);
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "UOMCode":
                var $tr = $thisobject.closest("tr");
                var UOMID = $tr.find('input[fieldname = "UOMID"]').first();

                $(UOMID).val("");

                if (val != "") {

                    $.ajax({
                        type: "GET", url: url, dataType: "json",
                        data: { type: 1, fieldname: fieldname, keyword: val },
                        success: function (data) {
                            if (data.rows != null) {
                                $(UOMID).val(data.rows.UOMID);
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "ItemCode":
                var $tr = $thisobject.closest("tr");
                var ItemName = $tr.find('input[fieldname = "ItemName"]').first();
                var ItemID = $tr.find('input[fieldname = "ItemID"]').first();
                var UOMID = $tr.find('input[fieldname = "UOMID"]').first();
                var UOMCode = $tr.find('select[fieldname = "UOMCode"]').first();

                var AccountDebitLineID = $tr.find('input[fieldname = "AccountDebitLineID"]').first();
                var DisplayNumberLineDebit = $tr.find('select[fieldname = "DisplayNumberLineDebit"]').first();

                var UnitPrice = $tr.find('input[fieldname = "UnitPrice"]').first();
                var UnitPriceFC = $tr.find('input[fieldname = "UnitPriceFC"]').first();
                $(UnitPrice).autoNumericSet(0);
                $(UnitPriceFC).autoNumericSet(0);
                var CustomerID = parseFloat($(sectionid + '#CustomerID').autoNumericGet());
                var VoucherDate = $(sectionid + '#VoucherDate').val();

                $(ItemName).val("");
                $(ItemID).val("");
                $(UOMID).val("");
                $(UOMCode).selectizesetvalue("");

                $(AccountDebitLineID).val("");
                $(DisplayNumberLineDebit).selectizesetvalue("");

                if (val != "") {

                    $.ajax({
                        type: "POST", url: url, dataType: "json",
                        data: { type: 1, fieldname: fieldname, keyword: val, customerid: CustomerID, voucherdate: VoucherDate },
                        success: function (data) {
                            if (data.rows != null) {

                                $(ItemName).val(data.rows.Name);
                                $(ItemID).val(data.rows.ItemID);
                                $(UOMID).val(data.rows.UOMID);
                                $(UOMCode).selectizesetvalue(data.rows.UOMCode);

                                $(AccountDebitLineID).val(data.rows.AccountID);
                                $(DisplayNumberLineDebit).selectizesetvalue(data.rows.DisplayNumber);

                                $(UnitPrice).autoNumericSet(data.extrows.UnitPrice);
                                $(UnitPriceFC).autoNumericSet(data.extrows.UnitPriceFC);
                            }
                            else {
                                $thisobject[0].selectize.setValue('');
                                $thisobject[0].selectize.clearOptions();
                            }
                        }
                    });
                }
                break;
            case "Quantity0":
                var $tr = $thisobject.closest("tr");
                var IsoCode = $(sectionid + '#IsoCode').val();
                var isFC = (IsoCode.toUpperCase() != globlevar_isocode.toUpperCase());

                if (isFC) {
                    var UnitPriceFC = $tr.find('input[fieldname = "UnitPriceFC"]').first();
                    fieldchange(UnitPriceFC);
                }
                else {
                    var UnitPrice = $tr.find('input[fieldname = "UnitPrice"]').first();
                    fieldchange(UnitPrice);
                }
                break;
            case "UnitPriceFC":
                var $tr = $thisobject.closest("tr");
                var AmountFC = $tr.find('input[fieldname = "AmountFC"]:first');
                var UnitPriceFCValue = parseFloat($thisobject.autoNumericGet());
                var Quantity0Value = parseFloat($tr.find('input[fieldname = "Quantity0"]').first().autoNumericGet());
                var AmountFCValue = UnitPriceFCValue * Quantity0Value;
                $(AmountFC).autoNumericSet(AmountFCValue);

                var ExchangeRateValue = parseFloat($(sectionid + '#ExchangeRate').autoNumericGet());
                var UnitPriceValue = ExchangeRateValue * UnitPriceFCValue;
                $tr.find('input[fieldname = "UnitPrice"]:first').autoNumericSet(UnitPriceValue);

                fieldchange(AmountFC);
                break;
            case "AmountFC":
                var $tr = $thisobject.closest("tr");
                var tablename = $tr.closest("table").attr("tablename");
                if (tablename == "AppVPO05VATView") {
                    var PurchaseTaxCode = $tr.find('select[fieldname = "PurchaseTaxCode"]').first();
                    fieldchange(PurchaseTaxCode);
                    validnumbervat($tr);
                }
                else {
                    var ExchangeRateValue = parseFloat($(sectionid + '#ExchangeRate').autoNumericGet());
                    var AmountFCValue = parseFloat($thisobject.autoNumericGet());
                    var AmountValue = ExchangeRateValue * AmountFCValue;
                    var Amount = $tr.find('input[fieldname = "Amount"]').first();
                    $(Amount).autoNumericSet(AmountValue);
                    fieldchange(Amount);
                }
                break;
            case "UnitPrice":
                var $tr = $thisobject.closest("tr");
                var UnitPriceValue = $thisobject.autoNumericGet();
                var Quantity0Value = $tr.find('input[fieldname = "Quantity0"]').first().autoNumericGet();
                var AmountValue = parseFloat(UnitPriceValue) * parseFloat(Quantity0Value);
                var Amount = $tr.find('input[fieldname = "Amount"]').first();
                $(Amount).autoNumericSet(AmountValue);
                fieldchange(Amount);
                break;
            case "Amount":
                var $tr = $thisobject.closest("tr");
                var tablename = $tr.closest("table").attr("tablename");
                if (tablename == "AppVPO05VATView") {
                    var PurchaseTaxCode = $tr.find('select[fieldname = "PurchaseTaxCode"]').first();
                    fieldchange(PurchaseTaxCode);
                }
                break;

            case "DutyPercentage":
                var $tr = $thisobject.closest("tr");
                var DutyPercentageValue = parseFloat($thisobject.autoNumericGet());
                var Duty = $tr.find('input[fieldname = "Duty"]').first();
                var DutyFC = $tr.find('input[fieldname = "DutyFC"]').first();
                var AmountValue = parseFloat($tr.find('input[fieldname = "Amount"]').first().autoNumericGet());
                var AmountFCValue = parseFloat($tr.find('input[fieldname = "AmountFC"]').first().autoNumericGet());
                $(Duty).autoNumericSet((AmountValue * DutyPercentageValue) / 100);
                $(DutyFC).autoNumericSet((AmountFCValue * DutyPercentageValue) / 100);

                fieldchange(Duty);
                break;

            case "DutyFC":
                var $tr = $thisobject.closest("tr");
                var ExchangeRateValue = parseFloat($(sectionid + '#ExchangeRate').autoNumericGet());
                var DutyFCValue = parseFloat($thisobject.autoNumericGet());
                var DutyValue = ExchangeRateValue * DutyFCValue;
                var Duty = $tr.find('input[fieldname = "Duty"]').first();
                $(Duty).autoNumericSet(DutyValue);
                fieldchange(Duty);
                break;
            case "Duty":
                form_refresh();
                break;
            case "AmountCostFC":
                var $tr = $thisobject.closest("tr");
                var ExchangeRateValue = parseFloat($(sectionid + '#ExchangeRate').autoNumericGet());
                var AmountCostFCValue = parseFloat($thisobject.autoNumericGet());
                var AmountCostValue = ExchangeRateValue * AmountCostFCValue;
                var AmountCost = $tr.find('input[fieldname = "AmountCost"]').first();
                $(AmountCost).autoNumericSet(AmountCostValue);
                fieldchange(AmountCost);
                break;
            case "MeasureRate":
                //validnumberline($thisobject.closest("tr"));
                break;
            case "AmountVATFC":
                validnumbervat($thisobject.closest("tr"));
                break;

            //case "Amount":
            //case "AmountFC":
            //    validnumberline($thisobject.closest("tr"));
            //    break;
            //case "AmountVAT":
            //case "AmountVATFC":
            //    validnumbervat($thisobject.closest("tr"));
            //    break;

            default:
                SenVietGlobal.ExObjectChange(a, url);

        }
    };

    //Kiểm tra thay đổi tất cả các text
    //$("#@(ajaxoption["ajaxupdateid"]) input[type='text'],#@(ajaxoption["ajaxupdateid"])  select").die(); //Xóa cache
    $("#@(ajaxoption["ajaxupdateid"]) input[type='text'],#@(ajaxoption["ajaxupdateid"])  select").on("change", function () {
        fieldchange(this);
    });

</script>
